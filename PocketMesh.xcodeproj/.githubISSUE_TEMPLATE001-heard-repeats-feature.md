---
name: Feature - Display Heard Repeats for Channel Messages
about: Show "Heard N repeats" below channel message bubbles, matching native app behavior
title: '[FEATURE] Display heard repeat count for flooded channel messages'
labels: enhancement, ui, messaging
assignees: ''
---

## Feature Description

Display **"Heard N repeats"** below channel message bubbles when the companion device hears repeated LoRa transmissions from mesh repeaters. This matches the behavior of the native MeshCore app.

### Visual Examples from Native App

The native app shows this feature in several ways:

1. **Message bubble status line**: "Heard 2 repeats âœ“" displayed below the message
2. **Message actions menu**: "Heard Repeats" action to view details
3. **Repeat details view**: Shows which repeaters relayed the message with SNR values
4. **Path visualization**: Shows the message propagation through the mesh

## Current Behavior

Currently, PocketMesh shows:
- âœ… Message delivery status ("Sent", "Delivered", "Failed")
- âœ… Round-trip time for ACKs
- âŒ **Missing**: Count of how many repeaters relayed the message

## Desired Behavior

### Basic Implementation (MVP)
Display repeat count below channel message bubbles:
- "Delivered" â†’ First ACK received
- "Delivered â€¢ Heard 2 repeats" â†’ Additional repeaters heard

### Display Rules
- **Show count only if** `heardRepeats > 1`
  - Don't show "Heard 1 repeat" (redundant with "Delivered")
  - Only show when multiple repeaters confirmed
- **Show only for channel messages** (flood routing)
  - Direct messages use path routing (different semantics)
- **Don't show for failed messages**

### Future Enhancements (Out of Scope for MVP)
- Tap to view repeat details (which repeaters, SNR values)
- Path visualization showing message propagation
- Network health indicators based on repeat counts

## Technical Background

### How It Works

The companion device's **LoRa radio listens** for repeated transmissions:

1. **You send** a channel message (flood routing)
2. **Repeaters hear** and retransmit the same packet
3. **Your device's radio hears** these retransmissions
4. **Firmware recognizes** "This is MY packet being repeated!"
5. **Firmware sends ACK event** via BLE for each repeat heard
6. **App receives** multiple ACK events with the same code
7. **MessageService counts** them: `heardRepeats++`

**Key Insight**: Repeaters are NOT sending acknowledgments back. Your companion device directly hears the repeated LoRa transmissions on the same frequency and counts them.

### Why This Matters

Heard repeat count indicates:
- âœ… **Mesh network health** (more repeats = better coverage)
- âœ… **Message propagation** (how far your message spread)
- âœ… **Repeater placement effectiveness** (which repeaters help relay)
- âœ… **Radio range assessment** (you only count what you can hear)

## Architecture

### Data Flow

```
User sends channel message
    â†“
MessageService.sendChannelMessage()
    â†“
Creates Message with heardRepeats = 0
    â†“
MeshCoreSession sends to device
    â†“
Device floods message on mesh
    â†“
Repeaters relay the packet
    â†“
Device hears repeats via LoRa radio
    â†“
Device sends ACK events (0x82) via BLE
    â†“
MessageService.handleAcknowledgement()
    â†“
First ACK: heardRepeats = 1, isDelivered = true
Subsequent ACKs: heardRepeats++
    â†“
SwiftData updates Message
    â†“
UI observes and refreshes
    â†“
UnifiedMessageBubble displays count
```

### Existing Infrastructure

âœ… **Already implemented:**
- `Message.heardRepeats: Int` property exists
- `MessageService` tracks repeat counts in `PendingAck`
- `handleAcknowledgement()` increments counter
- Grace period (60s) for late repeats
- Database persistence

âŒ **Missing:**
- UI display in `UnifiedMessageBubble`

## Implementation Plan

### Files to Modify

**1. `UnifiedMessageBubble.swift`** (Primary change)
- Add repeat count display to `statusRow`
- Conditional: only show if `message.heardRepeats > 1 && message.channelIndex != nil`
- Format: "Delivered â€¢ Heard N repeats"

### Code Changes Needed

```swift
// In UnifiedMessageBubble.swift, statusRow:

if message.direction == .outgoing {
    // Existing status text
    Text(statusText)
        .font(.caption2)
        .foregroundStyle(.secondary)
    
    // NEW: Add repeat count for channel messages
    if let channelIndex = message.channelIndex,
       message.heardRepeats > 1 {
        Text(" â€¢ ")
            .font(.caption2)
            .foregroundStyle(.secondary)
        
        Text("Heard \(message.heardRepeats) repeats")
            .font(.caption2)
            .foregroundStyle(.secondary)
    }
    
    // Existing checkmark/spinner
    if message.status == .delivered {
        Image(systemName: "checkmark")
            .font(.caption2)
            .foregroundStyle(.green)
    }
}
```

### Edge Cases to Handle

1. **Zero repeats** â†’ Don't show count
2. **One repeat** â†’ Don't show count (just "Delivered")
3. **Direct messages** â†’ Never show count (different routing)
4. **Failed messages** â†’ Never show count
5. **Late ACKs after grace period** â†’ Use last known count
6. **App restart** â†’ Display persisted count (no live updates)

## Testing Checklist

- [ ] Send channel message with 3 repeaters â†’ Shows "Heard 3 repeats"
- [ ] Send channel message alone â†’ Shows "Delivered" only
- [ ] Send DM to contact â†’ No repeat count shown
- [ ] Message fails â†’ No repeat count shown
- [ ] Delayed repeats arrive gradually â†’ Count updates in real-time
- [ ] After 60s grace period â†’ Count stops updating
- [ ] App backgrounded during ACKs â†’ Count updates on return
- [ ] App restarted with old message â†’ Shows last known count

## Upstream Merge Considerations

**Merge Risk**: ðŸŸ¢ **LOW**

This feature is **additive only**:
- âœ… No changes to core protocol handling
- âœ… No changes to database schema (property already exists)
- âœ… No changes to MessageService logic (already implemented)
- âœ… Only UI display changes in view layer
- âœ… Localized to single view component

**Merge Strategy**:
- Keep changes minimal and focused
- Use descriptive commit message
- Comment the display logic clearly
- Easy to cherry-pick or merge upstream changes

## Success Criteria

- [x] Infrastructure exists (`heardRepeats` tracked and persisted)
- [ ] UI displays count for channel messages only
- [ ] Count updates in real-time as ACKs arrive
- [ ] No count shown for `heardRepeats <= 1`
- [ ] No count shown for direct messages
- [ ] No performance impact on message rendering
- [ ] Matches native app behavior

## Related Documentation

- `docs/enhancements/001-heard-repeats-display.md` - Feature specification
- `docs/enhancements/001-heard-repeats-architecture.md` - Architecture details
- `docs/enhancements/001-heard-repeats-implementation-guide.md` - Implementation guide
- Native MeshCore app - Visual reference

## Questions

1. **Should we show "Heard 1 repeat"?**
   - **Decision**: No, it's redundant with "Delivered"
   
2. **Should we support tap-to-view details?**
   - **Decision**: Out of scope for MVP (future enhancement)
   
3. **Should we show for direct messages?**
   - **Decision**: No, only channel messages (flood routing)

4. **What if no repeats are heard?**
   - **Decision**: Just show "Delivered" (or "Sent"/"Failed")

## Implementation Priority

**Priority**: ðŸ”µ Medium

- Not critical for core functionality
- Adds valuable network health feedback
- Low implementation complexity
- High user value for mesh network visibility

---

**Estimated Effort**: 2-4 hours
- UI changes: 1-2 hours
- Testing: 1-2 hours

**Assignee**: @jtstockton
**Milestone**: v1.1
**Target Date**: TBD
